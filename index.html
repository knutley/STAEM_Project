<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Holyrood 2026 — Scottish Parliament Election Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0a0e1a;
    --bg2: #111827;
    --bg3: #1a2235;
    --border: #2a3450;
    --text: #e8eaf2;
    --text-muted: #7a8aaa;
    --text-dim: #4a5878;
    --accent: #f0c040;
    --snp: #FDF38E;
    --lab: #E4003B;
    --con: #0087DC;
    --lib: #FAA61A;
    --grn: #00B140;
    --rfm: #12B6CF;
    --alba: #005EB8;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    font-weight: 300;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }

  header {
    border-bottom: 1px solid var(--border);
    padding: 0 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 72px;
    position: sticky;
    top: 0;
    background: rgba(10,14,26,0.95);
    backdrop-filter: blur(12px);
    z-index: 100;
  }

  .header-left { display: flex; align-items: baseline; gap: 16px; }
  .header-title { font-family: 'Playfair Display', serif; font-weight: 900; font-size: 1.35rem; letter-spacing: -0.02em; }
  .header-subtitle { font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; color: var(--text-muted); letter-spacing: 0.12em; text-transform: uppercase; }
  .header-right { display: flex; align-items: center; gap: 20px; }

  .election-countdown { font-family: 'IBM Plex Mono', monospace; font-size: 0.72rem; color: var(--text-muted); text-align: right; }
  .countdown-number { font-size: 1.1rem; color: var(--accent); font-weight: 500; display: block; }

  .refresh-btn {
    background: transparent; color: var(--text-muted); border: 1px solid var(--border);
    padding: 9px 20px; font-family: 'IBM Plex Mono', monospace; font-size: 0.72rem;
    letter-spacing: 0.08em; cursor: pointer; text-transform: uppercase; transition: all 0.2s;
  }
  .refresh-btn:hover { border-color: var(--accent); color: var(--accent); }
  .refresh-btn.loading { opacity: 0.5; pointer-events: none; }

  main { padding: 40px; max-width: 1400px; margin: 0 auto; }

  .section-label {
    font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; letter-spacing: 0.2em;
    text-transform: uppercase; color: var(--text-dim); margin-bottom: 20px;
    padding-bottom: 8px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
  }
  .section-label::before { content: ''; width: 20px; height: 1px; background: var(--accent); }

  .status-bar {
    display: flex; gap: 16px; margin-bottom: 32px; padding: 14px 20px;
    background: var(--bg2); border: 1px solid var(--border);
    font-family: 'IBM Plex Mono', monospace; font-size: 0.63rem;
    color: var(--text-muted); flex-wrap: wrap; align-items: center;
  }
  .status-item { display: flex; align-items: center; gap: 7px; }
  .status-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
  .status-dot.ok      { background: #4ade80; }
  .status-dot.loading { background: var(--accent); animation: pulse 1s infinite; }
  .status-dot.error   { background: #f87171; }
  .status-dot.empty   { background: var(--text-dim); }
  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.3} }

  .tab-row { display: flex; gap: 2px; margin-bottom: 28px; }
  .tab-btn {
    background: var(--bg2); border: 1px solid var(--border); color: var(--text-muted);
    padding: 10px 24px; font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem;
    letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; transition: all 0.2s;
  }
  .tab-btn.active { background: var(--accent); color: #0a0e1a; border-color: var(--accent); font-weight: 500; }
  .tab-btn:hover:not(.active) { border-color: var(--text-muted); color: var(--text); }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  .filter-row { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
  .filter-label { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-dim); margin-right: 4px; }
  .filter-btn {
    background: var(--bg2); border: 1px solid var(--border); color: var(--text-muted);
    padding: 6px 14px; font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem;
    letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; transition: all 0.2s;
  }
  .filter-btn.active { background: var(--bg3); border-color: var(--accent); color: var(--accent); }
  .filter-btn:hover:not(.active) { border-color: var(--text-muted); }

  .latest-strip {
    display: grid; grid-template-columns: repeat(6, 1fr);
    gap: 1px; background: var(--border); border: 1px solid var(--border); margin-bottom: 10px;
  }
  .strip-meta { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; color: var(--text-dim); margin-bottom: 32px; text-align: right; }
  .party-chip { background: var(--bg2); padding: 16px 12px; text-align: center; transition: background 0.2s; }
  .party-chip:hover { background: var(--bg3); }
  .party-chip-name { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; }
  .party-chip-pct { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 700; line-height: 1; }
  .party-dot { width: 6px; height: 6px; border-radius: 50%; margin: 0 auto 8px; }

  .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 40px; }
  .chart-card { background: var(--bg2); border: 1px solid var(--border); padding: 28px; }
  .chart-title { font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700; margin-bottom: 4px; }
  .chart-meta { font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; color: var(--text-muted); margin-bottom: 20px; }
  .chart-container { position: relative; height: 280px; }

  .pollster-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 40px; }
  .pollster-card { background: var(--bg2); border: 1px solid var(--border); padding: 22px; }
  .pollster-card-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
  .pollster-card-name { font-family: 'Playfair Display', serif; font-size: 1.05rem; font-weight: 700; }
  .pollster-card-date { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; color: var(--text-dim); }
  .pollster-bars { display: flex; flex-direction: column; gap: 9px; }
  .pollster-bar-row { display: flex; align-items: center; gap: 8px; }
  .pollster-bar-label { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; width: 52px; flex-shrink: 0; }
  .pollster-bar-track { flex: 1; height: 6px; background: var(--bg3); border-radius: 2px; overflow: hidden; }
  .pollster-bar-fill { height: 100%; border-radius: 2px; transition: width 0.8s cubic-bezier(0.4,0,0.2,1); }
  .pollster-bar-pct { font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; width: 36px; text-align: right; flex-shrink: 0; }

  .polls-table-wrap { margin-bottom: 40px; overflow-x: auto; }
  .polls-table { width: 100%; border-collapse: collapse; font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; min-width: 800px; }
  .polls-table th { text-align: left; padding: 8px 12px; color: var(--text-dim); font-size: 0.6rem; letter-spacing: 0.12em; text-transform: uppercase; border-bottom: 1px solid var(--border); white-space: nowrap; }
  .polls-table td { padding: 10px 12px; border-bottom: 1px solid rgba(42,52,80,0.5); color: var(--text-muted); white-space: nowrap; }
  .polls-table tr:hover td { background: var(--bg3); }
  .polls-table td.col-pollster { color: var(--text); font-weight: 500; }
  .pollster-tag { display: inline-block; padding: 1px 7px; font-size: 0.58rem; letter-spacing: 0.08em; border: 1px solid var(--border); }
  .pollster-tag.survation { border-color: #a78bfa44; color: #a78bfa; }
  .pollster-tag.norstat   { border-color: #fb923c44; color: #fb923c; }
  .pollster-tag.ipsos     { border-color: #38bdf844; color: #38bdf8; }

  .incumbent-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px; }
  .summary-card { background: var(--bg2); border: 1px solid var(--border); padding: 20px 24px; }
  .summary-card-label { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
  .summary-card-num { font-family: 'Playfair Display', serif; font-size: 2.2rem; font-weight: 700; line-height: 1; }

  .incumbency-table-wrap { overflow-x: auto; margin-bottom: 40px; }
  .incumbency-table { width: 100%; border-collapse: collapse; font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; }
  .incumbency-table th { text-align: left; padding: 8px 12px; color: var(--text-dim); font-size: 0.6rem; letter-spacing: 0.12em; text-transform: uppercase; border-bottom: 1px solid var(--border); white-space: nowrap; background: var(--bg2); }
  .incumbency-table td { padding: 10px 12px; border-bottom: 1px solid rgba(42,52,80,0.5); color: var(--text-muted); }
  .incumbency-table tr:hover td { background: var(--bg3); }
  .incumbency-table td.constituency-name { color: var(--text); font-weight: 500; }
  .standing-yes     { color: #4ade80; font-size: 0.65rem; }
  .standing-no      { color: #f87171; font-size: 0.65rem; }
  .standing-unknown { color: var(--text-dim); font-size: 0.65rem; }
  .winner-badge { display: inline-block; padding: 2px 8px; font-size: 0.6rem; font-weight: 500; letter-spacing: 0.08em; text-transform: uppercase; }

  .empty-state { text-align: center; padding: 48px 20px; color: var(--text-dim); font-family: 'IBM Plex Mono', monospace; font-size: 0.72rem; }

  footer { border-top: 1px solid var(--border); padding: 24px 40px; display: flex; justify-content: space-between; align-items: center; }
  .footer-text { font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; color: var(--text-dim); }
  .footer-sources a { color: var(--text-muted); text-decoration: none; font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; margin-left: 16px; transition: color 0.2s; }
  .footer-sources a:hover { color: var(--accent); }

  @media (max-width: 900px) {
    .charts-grid, .pollster-grid, .incumbent-summary { grid-template-columns: 1fr; }
    .latest-strip { grid-template-columns: repeat(3, 1fr); }
    header, main, footer { padding-left: 20px; padding-right: 20px; }
  }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <span class="header-title">Holyrood 2026</span>
    <span class="header-subtitle">Scottish Parliament Election Tracker</span>
  </div>
  <div class="header-right">
    <div class="election-countdown">
      <span class="countdown-number" id="daysLeft">—</span>
      days to 7 May 2026
    </div>
    <button class="refresh-btn" id="refreshBtn" onclick="loadAll()">↻ Refresh</button>
  </div>
</header>

<main>

  <div class="status-bar" id="statusBar">
    <div class="status-item"><div class="status-dot loading" id="dot-cs"></div><span id="st-cs">Constituency: Survation…</span></div>
    <div class="status-item"><div class="status-dot loading" id="dot-cn"></div><span id="st-cn">Constituency: Norstat…</span></div>
    <div class="status-item"><div class="status-dot loading" id="dot-ci"></div><span id="st-ci">Constituency: Ipsos…</span></div>
    <div class="status-item"><div class="status-dot loading" id="dot-ls"></div><span id="st-ls">List: Survation…</span></div>
    <div class="status-item"><div class="status-dot loading" id="dot-ln"></div><span id="st-ln">List: Norstat…</span></div>
    <div class="status-item"><div class="status-dot loading" id="dot-li"></div><span id="st-li">List: Ipsos…</span></div>
    <div class="status-item"><div class="status-dot loading" id="dot-inc"></div><span id="st-inc">Incumbency…</span></div>
    <div class="status-item" style="margin-left:auto;"><span id="st-updated" style="color:var(--text-dim)">—</span></div>
  </div>

  <div class="tab-row">
    <button class="tab-btn active" onclick="switchTab('polling', this)">Polling</button>
    <button class="tab-btn" onclick="switchTab('compare', this)">By Pollster</button>
    <button class="tab-btn" onclick="switchTab('incumbency', this)">Incumbency</button>
    <button class="tab-btn" onclick="switchTab('rawdata', this)">Raw Data</button>
  </div>

  <!-- POLLING TAB -->
  <div class="tab-panel active" id="tab-polling">
    <div class="section-label">Latest Constituency Vote — Polling Average</div>
    <div class="latest-strip" id="latestConstStrip">
      <div class="empty-state" style="grid-column:1/-1;padding:28px;">Loading…</div>
    </div>
    <div class="strip-meta" id="constAvgMeta">—</div>

    <div class="section-label">Latest Regional List Vote — Polling Average</div>
    <div class="latest-strip" id="latestListStrip">
      <div class="empty-state" style="grid-column:1/-1;padding:28px;">Loading…</div>
    </div>
    <div class="strip-meta" id="listAvgMeta">—</div>

    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title">Constituency Vote Over Time</div>
        <div class="chart-meta" id="constChartMeta">Loading…</div>
        <div class="chart-container"><canvas id="constituencyChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Regional List Vote Over Time</div>
        <div class="chart-meta" id="listChartMeta">Loading…</div>
        <div class="chart-container"><canvas id="listChart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- BY POLLSTER TAB -->
  <div class="tab-panel" id="tab-compare">
    <div class="section-label">Constituency Vote — Latest Reading by Pollster</div>
    <div class="pollster-grid" id="constPollsterCards">
      <div class="empty-state" style="grid-column:1/-1">Loading…</div>
    </div>
    <div class="section-label">Regional List Vote — Latest Reading by Pollster</div>
    <div class="pollster-grid" id="listPollsterCards">
      <div class="empty-state" style="grid-column:1/-1">Loading…</div>
    </div>
  </div>

  <!-- INCUMBENCY TAB -->
  <div class="tab-panel" id="tab-incumbency">
    <div class="incumbent-summary">
      <div class="summary-card">
        <div class="summary-card-label">Standing Again</div>
        <div class="summary-card-num" id="inc-yes" style="color:#4ade80">—</div>
      </div>
      <div class="summary-card">
        <div class="summary-card-label">Not Standing</div>
        <div class="summary-card-num" id="inc-no" style="color:#f87171">—</div>
      </div>
      <div class="summary-card">
        <div class="summary-card-label">Unknown / TBC</div>
        <div class="summary-card-num" id="inc-unknown" style="color:var(--text-dim)">—</div>
      </div>
    </div>
    <div class="filter-row" id="regionFilters">
      <span class="filter-label">Region:</span>
      <button class="filter-btn active" onclick="filterRegion('all', this)">All</button>
    </div>
    <div class="incumbency-table-wrap">
      <table class="incumbency-table">
        <thead>
          <tr>
            <th>Constituency</th><th>Region</th><th>2021 Winner (notional)</th>
            <th>2021 Vote %</th><th>Incumbent MSP</th><th>Standing?</th>
            <th>2026 Candidate</th><th>Notes</th>
          </tr>
        </thead>
        <tbody id="incumbencyTableBody"><tr><td colspan="8" class="empty-state">Loading…</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- RAW DATA TAB -->
  <div class="tab-panel" id="tab-rawdata">
    <div class="filter-row" id="pollsterFilterRow">
      <span class="filter-label">Pollster:</span>
      <button class="filter-btn active" onclick="filterPollster('all', this)">All</button>
      <button class="filter-btn" onclick="filterPollster('Survation', this)">Survation</button>
      <button class="filter-btn" onclick="filterPollster('Norstat', this)">Norstat</button>
      <button class="filter-btn" onclick="filterPollster('Ipsos', this)">Ipsos</button>
    </div>

    <div class="section-label">Constituency Vote — All Polls</div>
    <div class="polls-table-wrap">
      <table class="polls-table">
        <thead><tr>
          <th>Date</th><th>Pollster</th><th>Client</th><th>Sample</th>
          <th style="color:var(--snp)">SNP</th><th style="color:var(--con)">Con</th>
          <th style="color:var(--lab)">Lab</th><th style="color:var(--lib)">Lib Dem</th>
          <th style="color:var(--grn)">Green</th><th style="color:var(--alba)">Alba</th>
          <th style="color:var(--rfm)">Reform</th><th>Others</th>
        </tr></thead>
        <tbody id="constTableBody"><tr><td colspan="12" class="empty-state">Loading…</td></tr></tbody>
      </table>
    </div>

    <div class="section-label">Regional List Vote — All Polls</div>
    <div class="polls-table-wrap">
      <table class="polls-table">
        <thead><tr>
          <th>Date</th><th>Pollster</th><th>Client</th><th>Sample</th>
          <th style="color:var(--snp)">SNP</th><th style="color:var(--con)">Con</th>
          <th style="color:var(--lab)">Lab</th><th style="color:var(--lib)">Lib Dem</th>
          <th style="color:var(--grn)">Green</th><th style="color:var(--alba)">Alba</th>
          <th style="color:var(--rfm)">Reform</th><th>Others</th>
        </tr></thead>
        <tbody id="listTableBody"><tr><td colspan="12" class="empty-state">Loading…</td></tr></tbody>
      </table>
    </div>
  </div>

</main>

<footer>
  <span class="footer-text">Live data from Google Sheets · Last refreshed: <span id="lastUpdated">—</span></span>
  <div class="footer-sources">
    <a href="https://whatscotlandthinks.org/" target="_blank">What Scotland Thinks</a>
    <a href="https://ballotbox.scot/scottish-parliament/polling-scottish-parliament/" target="_blank">Ballot Box Scotland</a>
    <a href="https://scottishelections.ac.uk/scoop-monitor/" target="_blank">SCOOP</a>
  </div>
</footer>

<script>
// ── CONFIG ────────────────────────────────────────────────────
const SOURCES = {
  constituency: [
    { name: 'Survation', dotId: 'dot-cs', stId: 'st-cs', url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRVHoDYDQBczBB68faWVZ6fGRNqPSjlJj9-yTKLzJc6h7P1OT6HQiFvz8aXVSG-JH9fZrPoq3X1Bw1K/pub?output=csv' },
    { name: 'Norstat',   dotId: 'dot-cn', stId: 'st-cn', url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSkkfZ99xen3Z3FVOwVnxoqY2JZhxkEzejwagwS4p1n1f8awbC453uv5yb-ydAsagXz108FC-efiuQ_/pub?output=csv' },
    { name: 'Ipsos',     dotId: 'dot-ci', stId: 'st-ci', url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvwlOJGWbsgeU-1El-ruiXk0bo6_6Cv231HFmABtu7y1yukxmI8lrFDTveP3XSUXy6lfZi-RQ5_mKb/pub?output=csv' },
  ],
  list: [
    { name: 'Survation', dotId: 'dot-ls', stId: 'st-ls', url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR7RAJi3HPG0Eu49vOIf8yBR-v2vue3lUkc-iCmat81k3fNP4SOL3gixDwRRc_bKTxQ_SOmS6qVNwfY/pub?output=csv' },
    { name: 'Norstat',   dotId: 'dot-ln', stId: 'st-ln', url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRKZ0skhiQDkOWJplehISh4YktsynvLoSHYvqizkckRD2E8_AzXE-x0cO_WbhZ0HlmMzRgVHCaZJUD/pub?output=csv' },
    { name: 'Ipsos',     dotId: 'dot-li', stId: 'st-li', url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQujNr-IGnS63Sp1zn-lGV-xlO8hfZRxsKHC1udfblPWpfliy7gYFNSt-sTB5dhlAlwodu0ng8Ex9R9/pub?output=csv' },
  ],
  incumbency: { dotId: 'dot-inc', stId: 'st-inc', url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTl6WYteXtuKhFCT5lgfE8HC9_QLjZi98emDf_pijvNjctmvHo3Xqr9av_mamvaA5i7HzS-D-JU_iol/pub?output=csv' },
};

const PARTIES = [
  { key: 'snp', label: 'SNP',     color: '#FDF38E' },
  { key: 'con', label: 'Con',     color: '#0087DC' },
  { key: 'lab', label: 'Labour',  color: '#E4003B' },
  { key: 'lib', label: 'Lib Dem', color: '#FAA61A' },
  { key: 'grn', label: 'Green',   color: '#00B140' },
  { key: 'rfm', label: 'Reform',  color: '#12B6CF' },
];

const POLLSTER_COLORS = { Survation: '#a78bfa', Norstat: '#fb923c', Ipsos: '#38bdf8' };

// ── STATE ─────────────────────────────────────────────────────
let constPolls = [], listPolls = [], incumbency = [];
let activePollsterFilter = 'all', activeRegion = 'all';

// ── COUNTDOWN ─────────────────────────────────────────────────
function updateCountdown() {
  const diff = Math.ceil((new Date('2026-05-07') - new Date()) / 86400000);
  document.getElementById('daysLeft').textContent = Math.max(0, diff);
}
updateCountdown();
setInterval(updateCountdown, 3600000);

// ── TABS ──────────────────────────────────────────────────────
function switchTab(name, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  btn.classList.add('active');
}

// ── CSV PARSER ────────────────────────────────────────────────
function parseCSV(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];
  return lines.slice(1).map(line => {
    const cols = []; let cur = '', inQ = false;
    for (let i = 0; i < line.length; i++) {
      if (line[i] === '"') { inQ = !inQ; }
      else if (line[i] === ',' && !inQ) { cols.push(cur.trim()); cur = ''; }
      else { cur += line[i]; }
    }
    cols.push(cur.trim());
    return cols;
  }).filter(r => r.some(c => c));
}

function pct(v) {
  if (!v || v === '' || v === '-' || v === 'N/A') return null;
  return parseFloat(String(v).replace('%', '')) || null;
}

function parsePollRow(row, sourceName) {
  return {
    date:    row[0] || '',
    pollster: row[1] || sourceName,
    client:  row[2] || '',
    sample:  row[3] || '',
    snp:  pct(row[4]), con:  pct(row[5]), lab:  pct(row[6]),
    lib:  pct(row[7]), grn:  pct(row[8]), alba: pct(row[9]),
    rfm:  pct(row[10]), others: pct(row[11]),
    _source: sourceName,
  };
}

function parseDate(s) {
  if (!s) return null;
  const dmy = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (dmy) {
    const y = dmy[3].length === 2 ? '20' + dmy[3] : dmy[3];
    return new Date(`${y}-${dmy[2].padStart(2,'0')}-${dmy[1].padStart(2,'0')}`);
  }
  const d = new Date(s);
  return isNaN(d) ? null : d;
}

function fmtDate(s) {
  const d = parseDate(s);
  return d ? d.toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'2-digit' }) : s;
}

function sortByDate(arr) {
  return arr.slice().sort((a, b) => {
    const da = parseDate(a.date), db = parseDate(b.date);
    return (!da || !db) ? 0 : da - db;
  });
}

// ── STATUS ────────────────────────────────────────────────────
function setStatus(dotId, stId, state, msg) {
  document.getElementById(dotId).className = 'status-dot ' + state;
  document.getElementById(stId).textContent = msg;
}

// ── FETCH ─────────────────────────────────────────────────────
async function fetchCSV(src) {
  try {
    const resp = await fetch(src.url);
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const rows = parseCSV(await resp.text());
    const polls = rows.map(r => parsePollRow(r, src.name)).filter(p => p.date);
    setStatus(src.dotId, src.stId, polls.length ? 'ok' : 'empty',
      `${src.name}: ${polls.length} poll${polls.length !== 1 ? 's' : ''}`);
    return polls;
  } catch(e) {
    setStatus(src.dotId, src.stId, 'error', `${src.name}: failed`);
    return [];
  }
}

async function loadAll() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('loading'); btn.textContent = '↻ Loading…';

  [...SOURCES.constituency, ...SOURCES.list].forEach(s =>
    setStatus(s.dotId, s.stId, 'loading', s.name + '…'));
  setStatus(SOURCES.incumbency.dotId, SOURCES.incumbency.stId, 'loading', 'Incumbency…');

  const [cResults, lResults] = await Promise.all([
    Promise.all(SOURCES.constituency.map(fetchCSV)),
    Promise.all(SOURCES.list.map(fetchCSV)),
  ]);

  constPolls = sortByDate(cResults.flat());
  listPolls  = sortByDate(lResults.flat());

  try {
    const resp = await fetch(SOURCES.incumbency.url);
    const rows = parseCSV(await resp.text());
    incumbency = rows.map(r => ({
      constituency: r[0]||'', region: r[1]||'', winner2021: r[2]||'',
      voteShare2021: r[3]||'', incumbentMSP: r[4]||'', standing: r[5]||'',
      candidate2026: r[6]||'', source: r[7]||'', notes: r[8]||'',
    })).filter(r => r.constituency);
    setStatus(SOURCES.incumbency.dotId, SOURCES.incumbency.stId, 'ok',
      `Incumbency: ${incumbency.length} constituencies`);
    buildRegionFilters();
  } catch(e) {
    setStatus(SOURCES.incumbency.dotId, SOURCES.incumbency.stId, 'error', 'Incumbency: failed');
    incumbency = [];
  }

  document.getElementById('lastUpdated').textContent = new Date().toLocaleString('en-GB');
  document.getElementById('st-updated').textContent = 'Updated ' + new Date().toLocaleTimeString('en-GB');
  btn.classList.remove('loading'); btn.textContent = '↻ Refresh';
  render();
}

// ── AVERAGE ───────────────────────────────────────────────────
// Takes the most recent poll from each pollster and averages them
function computeAverage(polls) {
  const byPollster = {};
  polls.forEach(p => {
    const existing = byPollster[p._source];
    if (!existing || parseDate(p.date) > parseDate(existing.date))
      byPollster[p._source] = p;
  });
  const latest = Object.values(byPollster);
  if (!latest.length) return null;
  const avg = { _sources: latest.map(p => p._source), _latestDates: latest.map(p => fmtDate(p.date)) };
  PARTIES.forEach(pt => {
    const vals = latest.map(p => p[pt.key]).filter(v => v !== null);
    avg[pt.key] = vals.length ? Math.round(vals.reduce((a,b)=>a+b,0) / vals.length * 10) / 10 : null;
  });
  return avg;
}

// ── LATEST STRIP ──────────────────────────────────────────────
function renderLatestStrip(polls, stripId, metaId) {
  const strip = document.getElementById(stripId);
  const meta  = document.getElementById(metaId);
  if (!polls.length) {
    strip.innerHTML = `<div class="empty-state" style="grid-column:1/-1;padding:28px;">No data loaded</div>`;
    meta.textContent = '';
    return;
  }
  const avg = computeAverage(polls);
  if (!avg) return;
  strip.innerHTML = PARTIES.map(p => `
    <div class="party-chip">
      <div class="party-dot" style="background:${p.color}"></div>
      <div class="party-chip-name">${p.label}</div>
      <div class="party-chip-pct" style="color:${p.color}">${avg[p.key] !== null ? avg[p.key] + '%' : '—'}</div>
    </div>`).join('');
  meta.textContent = `Average of latest polls · Sources: ${avg._sources.join(', ')}`;
}

// ── CHARTS ────────────────────────────────────────────────────
let constChart, listChart;

const CHART_OPTS = {
  responsive: true, maintainAspectRatio: false,
  plugins: {
    legend: { position: 'bottom', labels: { color: '#7a8aaa', font: { family: "'IBM Plex Mono'", size: 10 }, boxWidth: 10, boxHeight: 10, padding: 14 } },
    tooltip: {
      backgroundColor: '#1a2235', borderColor: '#2a3450', borderWidth: 1,
      titleColor: '#e8eaf2', bodyColor: '#7a8aaa',
      titleFont: { family: "'IBM Plex Mono'", size: 11 }, bodyFont: { family: "'IBM Plex Mono'", size: 10 },
      callbacks: { label: ctx => `  ${ctx.dataset.label}: ${ctx.parsed.y !== null ? ctx.parsed.y + '%' : '—'}` }
    }
  },
  scales: {
    x: { grid: { color: 'rgba(42,52,80,0.4)' }, ticks: { color: '#4a5878', font: { family: "'IBM Plex Mono'", size: 10 }, maxRotation: 45 } },
    y: { min: 0, max: 55, grid: { color: 'rgba(42,52,80,0.4)' }, ticks: { color: '#4a5878', font: { family: "'IBM Plex Mono'", size: 10 }, callback: v => v + '%' } }
  },
  elements: { point: { radius: 3, hoverRadius: 5 }, line: { tension: 0.3, borderWidth: 2 } }
};

function buildDatasets(polls) {
  return PARTIES.map(p => ({
    label: p.label, data: polls.map(poll => poll[p.key]),
    borderColor: p.color, backgroundColor: p.color + '18',
    pointBackgroundColor: p.color, fill: false, spanGaps: true,
  }));
}

function initCharts() {
  constChart = new Chart(document.getElementById('constituencyChart').getContext('2d'), {
    type: 'line', data: { labels: [], datasets: buildDatasets([]) },
    options: JSON.parse(JSON.stringify(CHART_OPTS)),
  });
  listChart = new Chart(document.getElementById('listChart').getContext('2d'), {
    type: 'line', data: { labels: [], datasets: buildDatasets([]) },
    options: JSON.parse(JSON.stringify(CHART_OPTS)),
  });
}

function updateCharts() {
  [[constChart, constPolls, 'constChartMeta'], [listChart, listPolls, 'listChartMeta']].forEach(([chart, polls, mid]) => {
    if (!polls.length) { document.getElementById(mid).textContent = 'No data'; return; }
    chart.data.labels   = polls.map(p => fmtDate(p.date));
    chart.data.datasets = buildDatasets(polls);
    chart.update('active');
    const pollsters = [...new Set(polls.map(p => p._source))].join(', ');
    document.getElementById(mid).textContent = `${polls.length} polls · ${pollsters}`;
  });
}

// ── POLLSTER CARDS ────────────────────────────────────────────
function renderPollsterCards(polls, containerId) {
  const container = document.getElementById(containerId);
  const pollsters = [...new Set(polls.map(p => p._source))];
  if (!pollsters.length) {
    container.innerHTML = `<div class="empty-state" style="grid-column:1/-1">No data loaded</div>`;
    return;
  }
  container.innerHTML = pollsters.map(name => {
    const latest = [...polls].filter(p => p._source === name).pop();
    if (!latest) return '';
    const color = POLLSTER_COLORS[name] || '#7a8aaa';
    return `<div class="pollster-card">
      <div class="pollster-card-header">
        <div class="pollster-card-name" style="color:${color}">${name}</div>
        <div class="pollster-card-date">${fmtDate(latest.date)}${latest.client ? ' · ' + latest.client : ''}</div>
      </div>
      <div class="pollster-bars">
        ${PARTIES.map(p => `
          <div class="pollster-bar-row">
            <div class="pollster-bar-label" style="color:${p.color}">${p.label}</div>
            <div class="pollster-bar-track">
              <div class="pollster-bar-fill" style="width:${latest[p.key]||0}%;background:${p.color}"></div>
            </div>
            <div class="pollster-bar-pct" style="color:${p.color}">${latest[p.key] !== null ? latest[p.key]+'%' : '—'}</div>
          </div>`).join('')}
      </div>
    </div>`;
  }).join('');
}

// ── RAW TABLE ─────────────────────────────────────────────────
function filterPollster(name, btn) {
  document.querySelectorAll('#pollsterFilterRow .filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  activePollsterFilter = name;
  renderRawTables();
}

function renderPollsTable(polls, tbodyId) {
  const tbody = document.getElementById(tbodyId);
  const data  = activePollsterFilter === 'all' ? polls : polls.filter(p => p._source === activePollsterFilter);
  const fmt   = v => v !== null ? v + '%' : '—';
  if (!data.length) { tbody.innerHTML = `<tr><td colspan="12" class="empty-state">No polls to show</td></tr>`; return; }
  const tagCls = n => n.toLowerCase().includes('survation') ? 'survation' : n.toLowerCase().includes('norstat') ? 'norstat' : n.toLowerCase().includes('ipsos') ? 'ipsos' : '';
  tbody.innerHTML = [...data].reverse().map(p => `
    <tr>
      <td>${fmtDate(p.date)}</td>
      <td class="col-pollster"><span class="pollster-tag ${tagCls(p._source)}">${p._source}</span></td>
      <td style="font-style:italic;color:var(--text-muted)">${p.client}</td>
      <td>${p.sample}</td>
      <td style="color:var(--snp)">${fmt(p.snp)}</td>
      <td style="color:var(--con)">${fmt(p.con)}</td>
      <td style="color:var(--lab)">${fmt(p.lab)}</td>
      <td style="color:var(--lib)">${fmt(p.lib)}</td>
      <td style="color:var(--grn)">${fmt(p.grn)}</td>
      <td style="color:var(--alba)">${fmt(p.alba)}</td>
      <td style="color:var(--rfm)">${fmt(p.rfm)}</td>
      <td>${fmt(p.others)}</td>
    </tr>`).join('');
}

function renderRawTables() {
  renderPollsTable(constPolls, 'constTableBody');
  renderPollsTable(listPolls,  'listTableBody');
}

// ── INCUMBENCY ────────────────────────────────────────────────
function getPartyColor(name) {
  if (!name) return '#7a8aaa';
  const lc = name.toLowerCase();
  const map = { snp:'#FDF38E', labour:'#E4003B', conservative:'#0087DC', 'lib dem':'#FAA61A', liberal:'#FAA61A', green:'#00B140', alba:'#005EB8', reform:'#12B6CF' };
  for (const [k,v] of Object.entries(map)) if (lc.includes(k)) return v;
  return '#7a8aaa';
}

function buildRegionFilters() {
  const regions = [...new Set(incumbency.map(r => r.region).filter(Boolean))].sort();
  document.getElementById('regionFilters').innerHTML =
    `<span class="filter-label">Region:</span>
    <button class="filter-btn active" onclick="filterRegion('all',this)">All</button>` +
    regions.map(r => `<button class="filter-btn" onclick="filterRegion(${JSON.stringify(r)},this)">${r}</button>`).join('');
}

function filterRegion(region, btn) {
  document.querySelectorAll('#regionFilters .filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  activeRegion = region;
  renderIncumbency();
}

function renderIncumbency() {
  const data = activeRegion === 'all' ? incumbency : incumbency.filter(r => r.region === activeRegion);
  document.getElementById('inc-yes').textContent     = data.filter(r => r.standing.toLowerCase() === 'yes').length;
  document.getElementById('inc-no').textContent      = data.filter(r => r.standing.toLowerCase() === 'no').length;
  document.getElementById('inc-unknown').textContent = data.filter(r => !['yes','no'].includes(r.standing.toLowerCase())).length;

  const tbody = document.getElementById('incumbencyTableBody');
  if (!data.length) { tbody.innerHTML = `<tr><td colspan="8" class="empty-state">No data loaded</td></tr>`; return; }

  tbody.innerHTML = data.map(r => {
    const sc  = r.standing.toLowerCase() === 'yes' ? 'standing-yes' : r.standing.toLowerCase() === 'no' ? 'standing-no' : 'standing-unknown';
    const col = getPartyColor(r.winner2021);
    const badge = r.winner2021
      ? `<span class="winner-badge" style="background:${col}22;color:${col};border:1px solid ${col}44">${r.winner2021}</span>`
      : '—';
    return `<tr>
      <td class="constituency-name">${r.constituency}</td>
      <td style="font-size:0.65rem">${r.region}</td>
      <td>${badge}</td>
      <td>${r.voteShare2021||'—'}</td>
      <td style="color:var(--text)">${r.incumbentMSP||'—'}</td>
      <td><span class="${sc}">${r.standing||'Unknown'}</span></td>
      <td>${r.candidate2026||'—'}</td>
      <td style="font-size:0.65rem;max-width:180px;white-space:normal;color:var(--text-dim)">${r.notes||''}</td>
    </tr>`;
  }).join('');
}

// ── RENDER ────────────────────────────────────────────────────
function render() {
  renderLatestStrip(constPolls, 'latestConstStrip', 'constAvgMeta');
  renderLatestStrip(listPolls,  'latestListStrip',  'listAvgMeta');
  updateCharts();
  renderPollsterCards(constPolls, 'constPollsterCards');
  renderPollsterCards(listPolls,  'listPollsterCards');
  renderRawTables();
  renderIncumbency();
}

// ── INIT ──────────────────────────────────────────────────────
initCharts();
loadAll();
</script>
</body>
</html>
